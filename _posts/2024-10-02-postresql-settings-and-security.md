---
layout: post
title:  "PostgreSQL 외부접근 설정 및 보안관련 문제 해결 "
date:   2024-10-02 20:00:00 +0900
categories: Database
tags: Linux Postgre Security
---

## PostgreSQL 외부 접근 설정 및 보안 관련 문제 해결

**2024-10-02**

오늘은 GCP VM에서 PostgreSQL 서버의 외부 접근을 허용하고, 관련 보안 설정을 강화하는 작업을 진행했다. PostgreSQL의 **listen_addresses** 설정과 **pg_hba.conf** 파일을 통해 외부에서 안전하게 데이터베이스에 접근할 수 있도록 설정했고, 방화벽과 포트 설정을 점검하면서 다양한 리눅스 명령어를 익히게 되었다.

### 1. PostgreSQL `listen_addresses` 설정

`listen_addresses`는 PostgreSQL이 **어떤 네트워크 인터페이스에서 연결 요청을 수락할지를 결정하는 설정**이다. 기본적으로는 **localhost**에서만 연결을 수락하지만, 외부에서 PostgreSQL에 접근하려면 이를 수정해야 한다.

#### 설정의 목적

- **localhost**만 지정되어 있으면, 서버 자체에서만 PostgreSQL에 접근할 수 있다.
- 외부 네트워크에서 접근하려면 **`listen_addresses`**에 **0.0.0.0** 또는 **`*`**를 설정하여 **모든 인터페이스에서 연결을 수락**하도록 해야 한다.

#### 최종 설정 (postgresql.conf 파일)

```conf
listen_addresses = '0.0.0.0'  # 모든 네트워크 인터페이스에서 수락
```

또는

```conf
listen_addresses = '*'  # IPv4와 IPv6 모두에서 수락
```

#### 주의할 점

- **0.0.0.0**은 모든 네트워크 인터페이스에서 IPv4 연결을 수락하는 설정이다.
- `*`은 IPv4와 IPv6 모두에서 연결을 수락한다.
- 단, **보안 목적**으로는 이 설정만으로 충분하지 않다. PostgreSQL의 보안은 **방화벽 규칙**과 **pg_hba.conf** 파일에서 관리해야 한다.

### 2. PostgreSQL 보안 설정

PostgreSQL이 외부에서 접근할 수 있게 설정하더라도, **보안을 강화하는 추가 설정**이 필요하다. 이를 위해 **`pg_hba.conf`** 파일과 **GCP 방화벽** 설정을 수정했다.

#### `pg_hba.conf` 설정

`pg_hba.conf` 파일은 **PostgreSQL에 접근할 수 있는 IP 주소와 인증 방식을 지정하는 보안 설정 파일**이다. 아래와 같이 **나의 테스트 서버**에서 접근을 허용하도록 설정을 추가했다.

```
confCopy code# Raspberry Pi의 IP 주소를 허용
host    all             all             123.456.789.012/32       scram-sha-256
```

여기서 **scram-sha-256**은 보다 안전한 암호화 인증 방식이다. 이를 통해 특정 IP에서만 PostgreSQL에 접근할 수 있도록 제한했다.

### 3. GCP 방화벽 설정

GCP에서는 방화벽 규칙을 통해 포트 접근을 제어할 수 있다. PostgreSQL은 **5432 포트**를 사용하므로, 이 포트에 대한 외부 접근을 허용해야 했다. 방화벽에서 **테스트 서버의 WAN IP(123.456.789.012/32)**를 추가하여 접근을 허용했다.

#### 방화벽 설정 요약

- **5432 포트**: PostgreSQL의 기본 포트로, 외부에서 접근하려면 이 포트를 열어야 한다.
- 특정 IP 대역만 접근하도록 설정.

### 4. 포트 상태 확인을 위한 리눅스 명령어

이번 작업에서 특히 유용했던 몇 가지 리눅스 명령어가 있다. 포트 상태와 프로세스를 확인하는 데 사용되었고, 네트워크 관련 문제를 해결하는 데 큰 도움이 되었다.

#### 1. `netstat`

네트워크 상태를 확인하고, 특정 포트가 열려 있는지 확인할 수 있다.

```bash
sudo netstat -tuln | grep 5432
```

이 명령은 PostgreSQL이 **5432 포트**에서 정상적으로 수신 중인지 확인하는 데 사용되었다.

#### 2. `lsof`

특정 포트를 사용하는 프로세스를 확인하는 명령어.

```bash
sudo lsof -i :5432
```

이 명령은 **5432 포트**가 어떤 프로세스에 의해 사용되고 있는지 확인할 수 있다. PostgreSQL이 올바르게 5432 포트에서 수신 중인지 확인할 때 유용했다.

#### 3. `ps`

실행 중인 PostgreSQL 프로세스를 확인할 수 있는 명령어.

```bash
ps aux | grep postgres
```

이 명령을 통해 **PostgreSQL이 정상적으로 실행 중인지** 확인할 수 있다. 문제 발생 시 불필요한 프로세스를 종료하는 데에도 사용된다.

### 5. 결론

오늘 해결한 PostgreSQL 설정 문제는, **외부 접근을 허용하는 설정**과 **보안 강화**라는 두 가지 목표를 달성하기 위한 것이었다. 핵심은 **`listen_addresses` 설정을 통해 외부 인터페이스에서 연결을 수락**하면서, 동시에 **pg_hba.conf 파일과 GCP 방화벽**을 통해 접근을 제한하는 것이었다. 특히, 보안 설정을 강화한 후에도 PostgreSQL이 외부에서 잘 작동하도록 포트 상태를 점검하는 리눅스 명령어들이 유용하게 쓰였다.

이번 작업을 통해 **PostgreSQL의 네트워크 설정**과 **보안 설정**에 대해 좀 더 깊이 이해하게 되었다. 앞으로도 유사한 문제를 만나면, 오늘 사용한 설정과 명령어들을 참고해 빠르게 문제를 해결할 수 있을 것이다.

------

### 참고한 리눅스 명령어들:

1. `sudo netstat -tuln | grep 5432`: 포트 상태 확인
2. `sudo lsof -i :5432`: 포트를 사용하는 프로세스 확인
3. `ps aux | grep postgres`: PostgreSQL 프로세스 확인

------

이렇게 해서 오늘의 개발 이슈를 해결했다. PostgreSQL 설정에 대한 개념을 다시 한 번 확실히 이해할 수 있었고, 이를 바탕으로 외부 네트워크에서의 접근과 보안 강화를 동시에 처리할 수 있었다.

------

이 포스팅을 통해 PostgreSQL과 네트워크 관련 설정을 정리하고, 비슷한 상황에서 빠르게 대응할 수 있도록 기억해두자.