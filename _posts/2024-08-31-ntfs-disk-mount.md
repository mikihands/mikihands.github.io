---
layout: post
title:  "NTFS 파일시스템 디스크를 Linux에 마운트 하기"
date:   2024-08-31 20:45:00 +0900
categories: Linux
tags: Linux Disk_mount
---

## NTFS 파일시스템으로 포맷된 디스크를 마운트하기가 발생하는 이유

### 멀티부팅시 필수적인 디스크의 파티션 분할

많은 리눅스 OS를 사용하는 사람은 대개 서브로 윈도우를 멀티부팅으로 설치해두고 있을 것이다. 

이 경우 하나의 SSD를 여러개의 파티션으로 분할하여 사용하게 되는데, 최소 4개정도로 나뉘게 된다. 
Linux의 부팅을 위한 파티션, Linux가 실제 설치되고 운영될 디스크 파티션 (대가 Ext4 파일 시스템으로 포맷한다. ), 
그리고 윈도우 부팅을 위한 파티션, 마지막으로 윈도우가 사용할 저장공간 파티션 (윈도우의 경우 대부분 ntfs 파일시스템으로 포맷된다.)
이렇게 네가지로 분할 되는게 일반적이다. 

즉, 멀티 부팅을 윈도우로 하려고 하면 **어쩔 수 없이 리눅스에서 보편적으로 사용하지 않고 윈도우에서 주로 사용하는  nfts 파일 시스템의 디스크를 어쩔수없이 만들게 되는 셈**이다. 

### 윈도우 저장공간으로 확보한 디스크를 왜 굳이 리눅스쪽에서 마운트 하려하는가?

1. **그것이 가능하니까**

누군가가 유명한 등산가에게 "당신은 왜 위험한 산을 오르십니까?"라고 물었을 때, 등산가는 "산이 거기에 있으니까." 라고 답했다고 한다. 
누가 나에게 왜 일부러 윈도우를 위해 할당한 파티션을 굳이 리눅스 쪽에 마운트 하려고 해요? 라고 물으면, 
나의 대답은 "리눅스에서는 그게 되니까요." 라고 하겠다. 

윈도우에서는 리눅스파티션 쪽의 파티션을 접근할 수 없지만, 이 매력적인 오픈소스의 커스터마이징 최고 OS, 리눅스는 하드웨어에 대한 컨트롤 마저 
커스터마이징 할 수 있기에 윈도우쪽 파티션을 내 파일 시스템의 한 부분으로 마운트 해서 내가 마치 원래 내 저장공간 인 것처럼 쓸 수 있다. 

**이렇게 했을 때 얻을 수 있는 장점이 몇가지 있다.**

첫째, 가끔 윈도우쪽에 저장되어 있는 데이터를 열람하고 수정하기 위해서 컴퓨터를 리부팅 하여 윈도우쪽으로 부팅을 할 필요가 없어진다. 
드래곤볼에서 셀이 인조인간을 흡수하여 인조인간이 셀의 일부가 되고, 스타크래프트의 저그가 새로운 생명체를 흡수하여 자신의 일부로 만들 듯이 
윈도우쪽 파티션을 리눅스에 마운트 해버리면 그건 이미 내 파일시스템의 일부가 되어버렸다는 의미이다. 
굳이 데이터를 찾으러 윈도우쪽으로 재부팅 할 필요가 없어진다. 

둘째, 저장공간의 부족함을 느끼지 못하게 된다. 
예를 들어 1TB 의 SSD를 리눅스에 300 GB, 윈도우쪽에 700GB의 저장 디스크로 할당했다고 치자. 
이런경우 윈도우 측은 리눅스의 300 GB는 옆집 재산이고, 자신에게 할당된 700 GB으로 살림을 꾸려가야한다. 
그러나 리눅스는 300GB에 대한 저장공간이 적다하더라도 700GB의 윈도우 저장 디스크를 내 파일 시스템으로 마운트 해버리면, 
실제로는 1TB 의 전체를 리눅스가 사용할 수 있게 되는 것이다. 

### 마운트시 주의점

주의할 점이 몇가지 있다. 

Ext4 파일 시스템을 사용중인 리눅스가 NTFS 형식인 윈도우 쪽 파티션을 집어삼키기 위해서는 준비가 몇가지 필요하다. 

**첫번째, ntfs-3g 패키지의 설치**
영화 Matrix에서 Real World로 온 Neo에게 Tank가 플러그를 통해 각종 Matial Arts를 주입하자, 모피어스에게 처맞기만 하던 Neo가 모피어스와 대등하게 대결하는 모습이 있다.
이와 같이 Linux가 ntfs 파일시스템을 집어삼키고 관리하기위해서는 하나의 간단한 패키지를 설치해야한다. 
이미 대부분의 리눅스 우분투에는 설치 되어있을 테지만, 혹시 마운트에 실패할 경우 ntfs-3g가 제대로 설치되어 있는지 확인해볼 필요가 있다. 

설치여부 확인
```bash
sudo dpkg -l | grep ntfs-3g
```
만약 dpkg -l | grep ntfs-3g 명령어를 통해 아무런 출력이 없거나 패키지가 설치되지 않았다는 것을 알게 되면, 다음 명령어를 사용하여 ntfs-3g를 설치할 수 있다.

```bash
sudo apt-get update
sudo apt-get install ntfs-3g
sudo apt-get install --reinstall ntfs-3g #이전에 설치되어있었으나 제거되거나 재인스톨이 필요한 경우
```

**마운트 하기**

그런 다음 수동으로 마운트를 시도한다.
```bash
sudo mount -t ntfs-3g /dev/nvme0n1p3 /home/jesse/ssd 
```
여기서 `/dev/nvme0n1p3`는 ssd 장치의 위치이며, `/home/jesse/ssd` 는 마운트 하고싶은 곳으로 지정한다. 미리 디렉토리는 만들어 둬야 한다.

추가적인 정보를 위해 시스템 로그를 확인할 수도 있다.

```bash
sudo dmesg | grep nvme0n1p3
```
이 명령을 통해 오류 메시지와 관련된 더 자세한 로그를 확인할 수 있다.

리눅스 GUI버젼을 쓰는 경우 disk GUI 어플리케이션에서 쉽게 마운트 할 수도 있다. 

## 마운트된 디스크의 소유권 및 권한 설정

아무런 옵션없이 마운트 하면 소유자와 소유그룹이 root:root가 된다. 
물론 권한을 777로 주고 사용해도 좋지만, 보안을 위해서는 소유자를 나로 바꾸고 권한을 적절히 조절하는 것이 좋다. 

현재 마운트된 파티션을 먼저 언마운트한 후, 다음의 옵션을 사용하여 마운트한다.

```bash
sudo umount /home/jesse/ssd
sudo mount -t ntfs-3g -o uid=1000,gid=1000,dmask=027,fmask=137 /dev/nvme0n1p3 /home/jesse/ssd
```
여기서 uid=1000와 gid=1000은 일반적으로 첫 번째 사용자의 UID와 GID이다. 자신의 uid와 gid를 확인하고자 한다면 `grep <user> /etc/passwd`를 통해 확인하면 된다.
**참고** : 
- dmask=027: 디렉토리에 대한 기본 권한 마스크를 설정 (즉, 디렉토리의 권한을 750으로 설정).
- fmask=137: 파일에 대한 기본 권한 마스크를 설정 (즉, 파일의 권한을 640으로 설정).

## 마운트는 성공했으나, 쓰기가 안되는 경우

마운트에 성공했고, 디렉토리의 소유권과 모든 권한을 설정했음에도 읽기만 가능하고 쓰기가 안되는 경우가 있다. 

이는 두가지 문제를 집어보아야 한다. 

**첫째 ntfs 파티션 자체에 문제가 있는 경우,**

진단방법은 `sudo dmesg | grep ntfs`를 통해 
```
It is recommened to use chkdsk.
volume is dirty and "force" flag is not set!
```
등의 로그를 받은 경우에 해당한다. 이런경우 윈도우로 부팅하여 디스크 파일 시스템 체크와 복구를 해야한다. 

윈도우로 부팅한 후 터미널을 관리자권한으로 실행한 뒤, 
```sh
chkdsk /f /r C:
```
을 해주자. 그러면 십중팔구, 
```plaintext
PS C:\Users\jesse> chkdsk /f /r c:
파일 시스템 유형은 NTFS입니다.
현재 드라이브를 잠글 수 없습니다.

다른 프로세스가 볼륨을 사용하고 있으므로 CHKDSK를
실행할 수 없습니다. 다음에 시스템이 다시 시작할 때
이 볼륨을 검사하도록 하시겠습니까(Y/N)?
```
와 같은 응답을 보게된다. 이것은 해당 드라이브가 현재 Windows에서 사용 중이기 때문이다. 특히, 시스템 드라이브(C:)에서 이 명령어를 실행하려고 하면, Windows 운영 체제가 실행 중이기 때문에 드라이브를 잠글 수 없어서 chkdsk를 바로 실행할 수 없다.

바로 y를 누르고 시스템을 재부팅하자. 
그러면 윈도우가 시작하기전에 가장 먼저 디스크 체크와 복구를 실시하게 된다. 

디스크 체크와 복구가 완료되면 다시 우분투로 돌아가서 `mount | grep /dev/nvme0n1p3`르 해본다.(ssd디바이스 위치이름은 시스템별로 상이할 수 있으니 직접 확인하자) 
마운트 옵션에 `rw`가 아닌 `ro`(read only)로 되어있다면 아직 해결해야 문제가 한가지 더 있다. 

**두번째, 윈도우의 `fast Startup` 비활성화**

Fast Startup(빠른 시작)은 Windows 운영 체제에서 제공하는 기능으로, 컴퓨터의 부팅 시간을 줄이기 위해 개발되었다. 
이 기능은 Windows 8부터 도입되었으며, 기본적으로 활성화되어 있다. 
Fast Startup은 완전한 시스템 종료와 하이버네이션(절전 모드) 사이의 혼합된 형태로 동작한다.

- Fast Startup의 작동 방식
    - 일반 종료:

    컴퓨터를 종료할 때 Windows는 모든 사용자 세션을 종료하고, 모든 프로그램을 닫은 후 커널(session 0)과 장치 드라이버를 포함한 시스템 상태를 디스크에 저장하지 않고 완전히 종료한다.

    - Fast Startup 활성화 시:

    Fast Startup이 활성화된 경우, 사용자가 컴퓨터를 종료하면 모든 사용자 세션을 종료하고 프로그램을 닫지만, 커널과 장치 드라이버 상태는 하이버네이션 파일에 저장된다.
    이렇게 하면 재부팅 시 Windows가 하이버네이션 파일에서 커널과 장치 드라이버 상태를 복원하므로 부팅 시간이 크게 단축된다. 이것이 Fast Startup이 부팅 속도를 빠르게 하는 이유이다.

- Fast Startup의 단점 및 문제점

Fast Startup을 사용하면 NTFS 파일 시스템이 완전히 종료되지 않고 일부 데이터가 하이버네이션 파일에 남아 있을 수 있다. 이로 인해 Linux 기반 시스템에서 NTFS 파티션에 접근하려 할 때, 파일 시스템이 "unclean" 상태로 인식되어 읽기 전용으로 마운트될 수 있다.

이중 부팅 환경(예: Windows와 Linux)을 사용하는 경우, Fast Startup이 활성화된 상태에서는 Windows의 종료가 불완전하게 이루어질 수 있다. 이로 인해 Linux에서 NTFS 파티션을 수정하려고 할 때 문제가 발생하는 것이다. 

즉, Fast Startup은 완전한 종료가 아니므로, 일부 하드웨어나 시스템 업데이트가 제대로 적용되지 않을 수 있다. 완전한 시스템 종료를 위해서는 윈도우에서 Fast Startup을 비활성화하거나 Shift 키를 누른 상태에서 "종료"를 선택해야 한다.

**Fast Startup 비활성화 방법**

Fast Startup을 비활성화하려면 다음 단계를 따른다.:

1. 제어판에서 "전원 옵션"으로 이동:

1. "전원 단추 작동 설정" 선택:

1. 현재 사용할 수 없는 설정 변경 클릭

1. "빠른 시작 켜기" 옵션의 체크를 해제하여 비활성화 한다. 

1. 변경 사항 저장:

1. 변경 사항을 저장한 후 컴퓨터를 완전히 종료했다가 다시 부팅하면, Fast Startup이 비활성화된 상태에서 시스템이 부팅된다.

1. Linux로 부팅을 한 후 정상적으로 마운트되고 문제가 없는지 확인한다. 

**추가 보완사항**
마지막으로, NTFS 파티션을 정기적으로 사용하지 않는 경우에는 필요할 때만 마운트하고, 사용 후 언마운트하는 것이 좋다. 이는 시스템 성능과 안정성에 도움이 될 수 있다.

자주 사용하지 않는 NTFS 파티션을 언마운트해 두는 것은 몇 가지 이유에서 유리할 수 있다.

1. 시스템 성능 최적화
NTFS 파티션이 마운트된 상태로 유지되면 시스템이 해당 파티션을 지속적으로 모니터링하게 된다. 이는 특히 큰 파일 시스템일 경우 시스템 리소스를 소모할 수 있다. 따라서, 필요하지 않은 파티션은 언마운트해 두는 것이 시스템 성능을 최적화하는 데 도움이 된다.

2. 데이터 손상 방지
Linux에서 NTFS 파티션에 쓰기 작업을 수행할 경우, 예상치 못한 시스템 충돌이나 오류로 인해 데이터 손상이 발생할 수 있다. 특히, 파일 시스템이 클린하지 않은 상태로 마운트되었을 때 이러한 위험이 커진다. 자주 사용하지 않는 NTFS 파티션을 언마운트해 두면, 이런 상황에서 데이터를 보호할 수 있다.

3. 보안
마운트된 파티션은 접근 가능한 상태로 유지되므로, 의도치 않게 중요한 파일이 변경되거나 삭제될 위험이 있다. 이를 방지하기 위해 자주 사용하지 않는 파티션은 필요할 때만 마운트하고, 사용 후에는 언마운트하는 것이 보안 측면에서 유리하다.

4. 전원 관리
노트북이나 모바일 장치에서 특히 중요할 수 있는 점으로, 마운트된 NTFS 파티션이 전력 소모를 증가시킬 수 있다. 불필요한 파티션을 언마운트함으로써 전원 관리를 보다 효율적으로 할 수 있습니다.

5. 부트 문제 방지
간혹 NTFS 파티션이 제대로 언마운트되지 않은 상태에서 Linux를 종료하거나 재부팅할 경우, 다음 부팅 시 파일 시스템 체크가 필요해질 수 있다. 이러한 불편함을 피하기 위해 자주 쓰지 않는 파티션은 수동으로 언마운트하는 것이 좋다.

이러한 이유들로 인해 자주 사용하지 않는 NTFS 파티션은 필요할 때만 마운트하고, 사용 후에는 언마운트하도록 하자. 